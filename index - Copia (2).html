<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Contas a Pagar - WEB (SUPABASE)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // üîë Troque pelas credenciais do seu projeto Supabase
    const supabaseUrl = "https://vhfypgmvirktufrbgjjo.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZoZnlwZ212aXJrdHVmcmJnampvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNzIyMzUsImV4cCI6MjA3NDk0ODIzNX0.lVaVj1xbkEKK2tAytb5_m6X3FB0mnNzqla_kI0Fj2g4";
    
    // Inicializa√ß√£o correta usando o objeto global 'supabase' exposto pela CDN
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
  </script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        /* Estilos espec√≠ficos para o tooltip */
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 250px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        /* Custom CSS para garantir que as c√©lulas se comportem como table-cell apenas em MD */
        .grid-row-like {
            display: grid;
            grid-template-columns: 1fr; /* Default: Card mode */
        }

        @media (min-width: 768px) {
            .grid-row-like {
                display: table-row; /* Desktop: Table mode */
            }
        }
        
        /* --- ESTILOS DE IMPRESS√ÉO ATUALIZADOS --- */
        @media print {
            header, #esfera-filters, .mb-6.flex, #btnNovo, .md\:table-header-group th:last-child,
            .grid-row-like > div:last-child, .tooltiptext, .page-break-avoid,
            .grid.grid-cols-1.sm\:grid-cols-2.lg\:grid-cols-3.gap-4.mb-6 {
                display: none !important;
            }
            
            /* REQUISI√á√ÉO 1: Fonte menor para caber mais informa√ß√£o */
            body, .container {
                padding: 0 !important; margin: 0 !important; box-shadow: none !important;
                max-width: none !important; background-color: white !important; color: black !important;
                font-size: 8.5pt; 
            }
            #print-header { display: block !important; padding: 10px 0; border-bottom: 2px solid #000; margin-bottom: 10px; }
            #tabelaLancamentos { font-size: 8.5pt; width: 100%; border-collapse: collapse; }
            #tabelaLancamentos thead { background-color: white !important; color: black !important; border-bottom: 1px solid #000 !important; }
            #tabelaLancamentos thead th { color: black !important; font-weight: bold !important; }
            
            /* REQUISI√á√ÉO 2: Padding (espa√ßamento) drasticamente reduzido */
            #tabelaLancamentos thead th, #tabelaLancamentos tbody td {
                padding: 1px 3px !important; 
                border-bottom: 1px dotted #ccc; /* Linha discreta para guiar a leitura */
                color: #000 !important;
            }
            
            .grid-row-like { display: table-row !important; background-color: white !important; box-shadow: none !important; border: none !important; }
            
            /* REQUISI√á√ÉO 3: Sele√ß√£o de colunas - Escondendo 'Tipo' e 'Boleto' na impress√£o */
            .md\:table-header-group th:nth-child(4), .grid-row-like > div:nth-child(4), /* Coluna TIPO */
            .md\:table-header-group th:nth-child(8), .grid-row-like > div:nth-child(8) { /* Coluna BOLETO */
                display: none !important;
            }

            .grid-row-like > div:nth-child(9) span { color: black !important; background-color: transparent !important; border: 1px solid #ccc; padding: 0px 3px !important; font-size: 8pt; }

            .print-paisagem { @page { size: A4 landscape; } }
            .print-paisagem .hidden.md\:table-cell { display: table-cell !important; }
            #print-mini-dashboard { display: flex !important; gap: 20px; margin-bottom: 15px; page-break-after: avoid; }
            #print-mini-dashboard > div { border: 1px solid #ccc; padding: 5px 8px; flex-grow: 1; background-color: #f9f9f9; }
            #print-mini-dashboard h4 { font-size: 8pt; font-weight: bold; color: #555; margin: 0; padding: 0; }
            #print-mini-dashboard p { font-size: 11pt; font-weight: bold; color: #000; margin: 0; padding: 0; }
        }
    </style>
</head>
<body class="bg-gray-50 p-8">

<div class="container mx-auto max-w-7xl bg-white p-6 rounded-xl shadow-lg">
    
    <div id="print-header" style="display: none;">
        <div class="flex justify-between items-end mb-4">
            <img src="logo_contasimples.png" alt="Conta Simples Logo" class="w-24 h-auto">
            <h1 class="text-2xl font-bold text-gray-800 uppercase">RELAT√ìRIO DE CONTAS A PAGAR</h1>
        </div>
        <div id="print-filters" class="text-sm mt-3 mb-3 border-t border-gray-300 pt-2">
            <span class="font-bold">FILTROS:</span> <span id="filters-content" class="ml-2">Nenhum filtro aplicado.</span>
        </div>
    </div>
    
    <div id="print-mini-dashboard" style="display: none;">
        <div class="text-center"><h4>TOTAL DE LAN√áAMENTOS</h4><p id="print-total-valor">R$ 0,00</p></div>
        <div class="text-center"><h4>TOTAL PAGO</h4><p id="print-total-pago">R$ 0,00</p></div>
        <div class="text-center"><h4>QUANTIDADE</h4><p id="print-total-quantidade">0</p></div>
    </div>

    <header class="flex flex-wrap justify-between items-center mb-6 border-b pb-4 border-gray-200 page-break-avoid">
        <div class="flex items-center">
            <img src="logo_contasimples.png" alt="Conta Simples Logo" class="w-32 sm:w-40 h-auto">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 ml-4">Contas a Pagar</h1>
        </div>
        <div class="w-full sm:w-auto flex justify-end mt-4 sm:mt-0">
            <button id="btnImprimirRelatorio" class="px-3 sm:px-4 py-2 text-sm bg-blue-600 hover:bg-blue-700 rounded-lg text-white transition-colors flex items-center gap-2" title="Imprimir Relat√≥rio (A4 Paisagem)">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                <span class="hidden sm:inline">Imprimir Relat√≥rio</span>
            </button>
        </div>
    </header>

    <div id="esfera-filters" class="flex justify-start gap-4 mb-6 page-break-avoid">
        <button class="esfera-btn px-6 py-2 rounded-xl font-bold text-lg transition-colors border-2 border-transparent bg-slate-700 text-white" data-esfera="Todos">Todos</button>
        <button class="esfera-btn px-6 py-2 rounded-xl font-bold text-lg transition-colors border-2 border-slate-700 hover:bg-slate-200 text-slate-700" data-esfera="Empresa">Empresa</button>
        <button class="esfera-btn px-6 py-2 rounded-xl font-bold text-lg transition-colors border-2 border-slate-700 hover:bg-slate-200 text-slate-700" data-esfera="Pessoal">Pessoal</button>
    </div>
    
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6 page-break-avoid">
        <div class="bg-blue-50 border border-blue-200 rounded-xl p-1 shadow-sm text-center">
            <h3 class="text-sm font-semibold text-blue-700 uppercase tracking-wide">Total de Lan√ßamentos</h3>
            <p id="total-valor" class="mt-1 text-xl font-bold text-blue-900">R$ 0,00</p>
        </div>
        <div class="bg-green-50 border border-green-200 rounded-xl p-1 shadow-sm text-center">
            <h3 class="text-sm font-semibold text-green-700 uppercase tracking-wide">Total Pago</h3>
            <p id="total-pago" class="mt-1 text-xl font-bold text-green-900">R$ 0,00</p>
        </div>
        <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-1 shadow-sm text-center">
            <h3 class="text-sm font-semibold text-yellow-700 uppercase tracking-wide">Quantidade de Lan√ßamentos</h3>
            <p id="total-quantidade" class="mt-1 text-xl font-bold text-yellow-900">0</p>
        </div>
    </div>

    <div class="mb-6 flex flex-col md:flex-row md:items-center justify-between space-y-4 md:space-y-0 page-break-avoid">
        <div class="flex-grow mr-4 flex items-center gap-2">
            <input type="search" id="filtro-credor" placeholder="Buscar por credor..." class="block w-full text-lg rounded-md border-gray-500 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition-colors">
            <button id="btn-limpar-credor" class="px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 transition-colors">Limpar</button>
        </div>
        <div class="flex flex-wrap items-center gap-2">
            <select id="filtro-categoria" class="rounded-md border-gray-300 shadow-sm text-sm"><option value="Todos">Categoria</option></select>
            <select id="filtro-tipo" class="rounded-md border-gray-300 shadow-sm text-sm"><option value="Todos">Tipo</option></select>
            <div id="status-filters" class="flex flex-wrap gap-2">
                <button class="status-btn px-4 py-2 rounded-lg font-semibold transition-colors border border-gray-300 bg-gray-200 hover:bg-gray-300 text-gray-700" data-status="Todos">Todos</button>
                <button class="status-btn px-4 py-2 rounded-lg font-semibold transition-colors border border-gray-300 bg-blue-600 text-white" data-status="Hoje">Hoje</button>
                <button class="status-btn px-4 py-2 rounded-lg font-semibold transition-colors border border-gray-300 bg-gray-200 hover:bg-gray-300 text-gray-700" data-status="A Vencer">A Vencer</button>
                <button class="status-btn px-4 py-2 rounded-lg font-semibold transition-colors border border-gray-300 bg-gray-200 hover:bg-gray-300 text-gray-700" data-status="Vencido">Vencido</button>
                <button class="status-btn px-4 py-2 rounded-lg font-semibold transition-colors border border-gray-300 bg-gray-200 hover:bg-gray-300 text-gray-700" data-status="Pago">Pago</button>
            </div>
        </div>
    </div>
    
    <div class="flex items-center space-x-2 mb-6 page-break-avoid">
        <label for="filtro-inicial" class="text-sm font-medium text-gray-700">De:</label>
        <input type="date" id="filtro-inicial" class="rounded-md border-gray-300 shadow-sm text-sm">
        <label for="filtro-final" class="text-sm font-medium text-gray-700">At√©:</label>
        <input type="date" id="filtro-final" class="rounded-md border-gray-300 shadow-sm text-sm">
        <button id="btn-limpar-periodo" class="px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 transition-colors">Limpar</button>
    </div>

    <div class="overflow-x-auto">
        <table id="tabelaLancamentos" class="min-w-full divide-y divide-gray-500">
            <thead class="hidden md:table-header-group bg-gray-300">
                <tr>
                    <th class="hidden md:table-cell px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider max-w-[60px] overflow-hidden">DOC.</th>
                    <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider min-w-[120px]">Credor</th>
                    <th class="hidden md:table-cell px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-[120px]">Categoria</th>
                    <th class="hidden md:table-cell px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Tipo</th>
                    <th class="hidden md:table-cell px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Empresa</th>
                    <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider font-bold">Vencimento</th>
                    <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider max-w-[60px] overflow-hidden">Valor</th>
                    <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider max-w-[40px] overflow-hidden">Boleto</th>
                    <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Status</th>
                    <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">A√ß√µes</th>
                </tr>
            </thead>
            <tbody id="tabela-corpo-cards" class="md:table-row-group bg-white divide-y divide-gray-300 flex flex-col gap-2 md:gap-0">
            </tbody>
        </table>
    </div>
</div>

<div id="modalNovoLancamento" class="fixed inset-0 bg-gray-900 bg-opacity-50 backdrop-blur-sm z-50 flex justify-center items-start overflow-y-auto p-4 hidden">
    <div class="bg-gray-300 p-4 sm:p- rounded-xl shadow-2xl w-full max-w-lg md:max-w-3xl mt-8 mb-8 transform transition-all scale-95 duration-300 ease-in-out">
        <div class="flex justify-between items-center mb-4 border-b pb-3 border-gray-200">
            <div class="flex flex-col">
                <h2 id="modalTitle" class="text-2xl font-bold text-gray-800">Novo Lan√ßamento</h2>
                <span id="esfera" class="text-xs font-bold uppercase mt-1 px-3 py-0.5 rounded-full bg-slate-700 text-white w-min"></span>
            </div>
            <span class="close-btn text-gray-500 hover:text-gray-800 text-3xl font-bold cursor-pointer transition-colors">&times;</span>
        </div>
        
        <form id="formLancamento" class="space-y-2">
            <input type="hidden" id="lancamentoId">
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="col-span-1"><label for="doc" class="block text-sm font-medium text-gray-700">DOC</label><input type="text" id="doc" class="mt-1 block w-full text-base px-3 rounded-lg bg-gray-50 border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition-colors"></div>
                <div class="col-span-1 md:col-span-2"><label for="credor" class="block text-sm font-medium text-gray-700">Credor<span class="text-red-500">*</span></label><input type="text" id="credor" required class="mt-1 block w-full text-base px-3 rounded-lg bg-gray-50 border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition-colors"></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div><label for="categoria" class="block text-sm font-medium text-gray-700">Categoria<span class="text-red-500">*</span></label><input type="text" id="categoria" required class="mt-1 block w-full text-base px-3 rounded-lg bg-gray-50 border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition-colors"></div>
                <div><label for="tipo" class="block text-sm font-medium text-gray-700">Tipo<span class="text-red-500">*</span></label><select id="tipo" required class="mt-1 block w-full text-base px-3 rounded-lg bg-gray-50 border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition-colors"><option value="">Selecione...</option><option value="CUSTO FIXO">Custo Fixo</option><option value="CUSTO VARIAVEL">Custo Vari√°vel</option><option value="DESPESA FIXA">Despesa Fixa</option><option value="DESPESA VARIAVEL">Despesa Vari√°vel</option><option value="INVESTIMENTO">Investimento</option><option value="EMPR√âSTIMO">Empr√©stimo</option></select></div>
                <div><label for="empresa" class="block text-sm font-medium text-gray-700">Empresa<span class="text-red-500">*</span></label><select id="empresa" required class="mt-1 block w-full text-base px-3 rounded-lg bg-gray-50 border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition-colors"><option value="">Selecione...</option><option value="FOX">FOX</option><option value="S.OLIVEIRA">S.OLIVEIRA</option><option value="PAULO">PAULO</option><option value="ANGELA">ANGELA</option><option value="KADU">KADU</option><option value="ANDERSON">ANDERSON</option></select></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div><label for="emissao" class="block text-sm font-medium text-gray-700">Emiss√£o</label><input type="date" id="emissao" class="mt-1 block w-full text-base px-3 rounded-lg bg-gray-50 border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition-colors"></div>
                <div><label for="vencimento" class="block text-sm font-medium text-gray-700">Vencimento<span class="text-red-500">*</span></label><input type="date" id="vencimento" required class="mt-1 block w-full text-base px-3 rounded-lg bg-gray-50 border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition-colors"></div>
                <div><label for="valor" class="block text-sm font-medium text-gray-700">Valor<span class="text-red-500">*</span></label><input type="number" id="valor" step="0.01" required class="mt-1 block w-full text-base px-3 rounded-lg bg-gray-50 border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition-colors"></div>
            </div>
            <div><label for="observacao" class="block text-sm font-medium text-gray-700">Observa√ß√£o</label><textarea id="observacao" rows="1" class="mt-1 block w-full text-base px-3 rounded-lg bg-gray-50 border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition-colors"></textarea></div>

            <div id="parcelas-section" class="pt-3 pb-2 border-t border-b border-gray-200 bg-blue-50 p-3 rounded-lg">
                <div class="flex items-center gap-4">
                    <div class="flex items-center">
                        <input id="ativarParcelas" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="ativarParcelas" class="ml-2 block text-sm font-medium text-gray-800">Lan√ßar em parcelas?</label>
                    </div>
                </div>
                <div id="camposParcelas" class="flex items-center gap-2 mt-2 hidden">
                     <label for="numParcelas" class="text-sm font-medium text-gray-700">Lan√ßar</label>
                     <input type="number" id="numParcelas" min="2" class="block w-20 text-base px-3 rounded-lg bg-white border-gray-300 shadow-sm focus:border-blue-500" placeholder="Qtd.">
                     <label for="intervaloParcelas" class="text-sm font-medium text-gray-700 ml-2">parcelas, a cada</label>
                     <input type="number" id="intervaloParcelas" min="1" value="1" class="block w-20 text-base px-3 rounded-lg bg-white border-gray-300 shadow-sm focus:border-blue-500">
                     <select id="unidadeParcelas" class="block text-base px-3 rounded-lg bg-white border-gray-300 shadow-sm focus:border-blue-500">
                         <option value="meses" selected>meses</option>
                         <option value="dias">dias</option>
                     </select>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 bg-green-50 p-3 rounded-lg border border-green-200">
                <div><label for="data_pagt" class="block text-sm font-medium text-gray-700">Data Pagamento</label><input type="date" id="data_pagt" class="mt-1 block w-full text-base px-3 rounded-lg bg-gray-50 border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition-colors"></div>
                <div><label for="valor_pago" class="block text-sm font-medium text-gray-700">Valor Pago</label><input type="number" id="valor_pago" step="0.01" class="mt-1 block w-full text-base px-3 rounded-lg bg-gray-50 border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition-colors"></div>
                <div><label for="onde_pagou" class="block text-sm font-medium text-gray-700">Onde Pagou</label><input type="text" id="onde_pagou" class="mt-1 block w-full text-base px-3 rounded-lg bg-gray-50 border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition-colors"></div>
            </div>
            
            <div class="flex items-center mt-2">
                <input id="boleto" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                <label for="boleto" class="ml-2 block text-base font-medium text-gray-700">Boleto Recebido</label>
            </div>
            
            <div class="flex justify-end items-center gap-4 pt-4 border-t border-gray-200">
                <button type="button" id="btnCancel" class="bg-red-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-600 transition-colors w-1/4">Cancelar</button>
                <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors flex-grow">Salvar</button>
            </div>
        </form>
    </div>
</div>

<button id="btnNovo" aria-label="Novo Lan√ßamento" class="fixed bottom-6 right-6 z-40 bg-blue-600 hover:bg-green-700 text-white font-bold p-4 rounded-full transition-shadow duration-300 shadow-xl hover:shadow-2xl">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
</button>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Declara√ß√£o de Constantes do DOM ---
        const modal = document.getElementById('modalNovoLancamento');
        const btnNovo = document.getElementById('btnNovo');
        const closeButtons = document.querySelectorAll('.close-btn'); 
        const btnCancel = document.getElementById('btnCancel');
        const formLancamento = document.getElementById('formLancamento');
        const tabelaBody = document.getElementById('tabela-corpo-cards'); 
        const lancamentoIdField = document.getElementById('lancamentoId');
        const modalTitle = document.getElementById('modalTitle');
        const empresaSelect = document.getElementById('empresa');
        const esferaDisplay = document.getElementById('esfera');
        const totalValorElement = document.getElementById('total-valor');
        const totalPagoElement = document.getElementById('total-pago');
        const totalQuantidadeElement = document.getElementById('total-quantidade');
        const esferaFilterButtons = document.querySelectorAll('.esfera-btn');
        const statusFilterButtons = document.querySelectorAll('.status-btn');
        const filtroCredor = document.getElementById('filtro-credor');
        const filtroCategoria = document.getElementById('filtro-categoria');
        const filtroTipo = document.getElementById('filtro-tipo');
        const btnLimparFiltroCredor = document.getElementById('btn-limpar-credor');
        const filtroInicial = document.getElementById('filtro-inicial');
        const filtroFinal = document.getElementById('filtro-final');
        const btnLimparFiltroPeriodo = document.getElementById('btn-limpar-periodo');
        const btnImprimirRelatorio = document.getElementById('btnImprimirRelatorio');
        const mainContainer = document.querySelector('.container');
        const filtersContentElement = document.getElementById('filters-content');
        const printTotalValor = document.getElementById('print-total-valor');
        const printTotalPago = document.getElementById('print-total-pago');
        const printTotalQuantidade = document.getElementById('print-total-quantidade');
        const parcelasSection = document.getElementById('parcelas-section');
        const ativarParcelasCheckbox = document.getElementById('ativarParcelas');
        const camposParcelasDiv = document.getElementById('camposParcelas');
        const numParcelasInput = document.getElementById('numParcelas');
        const intervaloParcelasInput = document.getElementById('intervaloParcelas');
        const unidadeParcelasSelect = document.getElementById('unidadeParcelas');

        // --- Vari√°veis de Estado ---
        let currentEsferaFilter = 'Todos';
        let currentStatusFilter = 'Hoje'; 
        let currentCredorFilter = '';
        let currentCategoriaFilter = 'Todos';
        let currentTipoFilter = 'Todos';
        let currentStartDate = null;
        let currentEndDate = null;
        let lancamentos = [];
        
        // --- L√≥gica de Intera√ß√£o da UI ---
        ativarParcelasCheckbox.addEventListener('change', () => {
            camposParcelasDiv.classList.toggle('hidden', !ativarParcelasCheckbox.checked);
            if (!ativarParcelasCheckbox.checked) {
                numParcelasInput.value = '';
                intervaloParcelasInput.value = '1';
                unidadeParcelasSelect.value = 'meses';
            }
        });

        const fetchLancamentos = async () => {
            const { data, error } = await supabase.from("lancamentos").select("*");
            if (error) {
                console.error("Erro ao buscar:", error);
                alert("N√£o foi poss√≠vel carregar os dados do Supabase");
                return;
            }
            lancamentos = data;
            popularFiltrosSelect();
            renderizarTabela();
        };

        const popularFiltrosSelect = () => {
            const categorias = [...new Set(lancamentos.map(l => l.categoria).filter(Boolean))];
            const tipos = [...new Set(lancamentos.map(l => l.tipo).filter(Boolean))];
            filtroCategoria.innerHTML = '<option value="Todos">Categoria</option>';
            categorias.forEach(cat => { const option = document.createElement('option'); option.value = cat; option.textContent = cat; filtroCategoria.appendChild(option); });
            filtroTipo.innerHTML = '<option value="Todos">Tipo</option>';
            tipos.forEach(tipo => { const option = document.createElement('option'); option.value = tipo; option.textContent = tipo; filtroTipo.appendChild(option); });
            filtroCategoria.value = currentCategoriaFilter;
            filtroTipo.value = currentTipoFilter;
        };

        const formatarData = (data) => {
            if (!data) return '';
            const [ano, mes, dia] = data.split('-');
            return `${dia}/${mes}/${ano}`;
        };

        const formatarMoeda = (valor) => {
            if (valor === null || valor === undefined) return 'R$ 0,00';
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valor);
        };

        const getStatus = (lancamento) => {
            const hoje = new Date();
            const hojeFormatado = `${hoje.getFullYear()}-${String(hoje.getMonth() + 1).padStart(2, '0')}-${String(hoje.getDate()).padStart(2, '0')}`;
            if (lancamento.data_pagt) return 'Pago';
            if (lancamento.vencimento === hojeFormatado) return 'Hoje';
            if (lancamento.vencimento < hojeFormatado) return 'Vencido';
            return 'A Vencer';
        };

        const atualizarCardsDeResumo = (data) => {
            const totalValor = data.reduce((sum, l) => sum + l.valor, 0);
            const totalPago = data.reduce((sum, l) => sum + (l.valor_pago || 0), 0);
            const totalQuantidade = data.length;
            totalValorElement.textContent = formatarMoeda(totalValor);
            totalPagoElement.textContent = formatarMoeda(totalPago);
            totalQuantidadeElement.textContent = totalQuantidade;
        };

        const tooltipDelay = 2000;

        const renderizarTabela = () => {
            tabelaBody.innerHTML = '';
            let lancamentosFiltrados = [...lancamentos];

            if (currentEsferaFilter !== 'Todos') { lancamentosFiltrados = lancamentosFiltrados.filter(l => l.esfera === currentEsferaFilter); }
            if (currentStatusFilter !== 'Todos') { lancamentosFiltrados = lancamentosFiltrados.filter(l => getStatus(l) === currentStatusFilter); }
            if (currentCredorFilter) { lancamentosFiltrados = lancamentosFiltrados.filter(l => l.credor.toLowerCase().includes(currentCredorFilter.toLowerCase())); }
            if (currentCategoriaFilter !== 'Todos') { lancamentosFiltrados = lancamentosFiltrados.filter(l => l.categoria === currentCategoriaFilter); }
            if (currentTipoFilter !== 'Todos') { lancamentosFiltrados = lancamentosFiltrados.filter(l => l.tipo === currentTipoFilter); }
            if (currentStartDate && currentEndDate) {
                const start = new Date(currentStartDate);
                const end = new Date(currentEndDate);
                const finalComum = new Date(end);
                finalComum.setDate(finalComum.getDate() + 1); 
                lancamentosFiltrados = lancamentosFiltrados.filter(l => {
                    const vencimento = new Date(l.vencimento);
                    return vencimento >= start && vencimento < finalComum;
                });
            }

            lancamentosFiltrados.sort((a, b) => new Date(a.vencimento) - new Date(b.vencimento));

            lancamentosFiltrados.forEach(lancamento => {
                const status = getStatus(lancamento);
                let statusClass = 'text-blue-600 font-semibold', statusBgClass = 'bg-blue-100';
                if (status === 'Pago') { statusClass = 'text-green-600 font-semibold'; statusBgClass = 'bg-green-100'; }
                else if (status === 'Hoje') { statusClass = 'text-yellow-700 font-semibold'; statusBgClass = 'bg-yellow-100'; }
                else if (status === 'Vencido') { statusClass = 'text-red-600 font-semibold'; statusBgClass = 'bg-red-100'; }
                
                const linha = document.createElement('div');
                linha.className = 'grid-row-like bg-white p-2 md:p-0 rounded-lg md:shadow-none md:hover:bg-gray-200 transition-all group tooltip md:border-l-0'; 
                
                linha.innerHTML = `
                    <div class="hidden md:table-cell md:p-2 whitespace-nowrap text-xs text-gray-900 truncate max-w-[50px]">${lancamento.doc || ''}</div>
                    <div class="font-semibold text-lg md:text-base md:table-cell md:p-2 whitespace-nowrap text-gray-900 truncate max-w-[200px]">${lancamento.credor}<span class="md:hidden text-xs font-normal text-gray-500 block">${lancamento.categoria} - ${lancamento.empresa}</span></div>
                    <div class="hidden md:table-cell md:p-2 whitespace-nowrap text-sm text-gray-600 truncate max-w-[100px]">${lancamento.categoria}</div>
                    <div class="hidden md:table-cell md:p-2 whitespace-nowrap text-sm text-gray-600 truncate max-w-[100px]">${lancamento.tipo || ''}</div>
                    <div class="hidden md:table-cell md:p-2 whitespace-nowrap text-sm text-gray-900 truncate max-w-[50px]">${lancamento.empresa}</div>
                    <div class="md:table-cell md:p-2 whitespace-nowrap text-base font-bold text-gray-900 max-w-[60px] flex justify-between items-center"><span class="md:hidden text-sm font-semibold text-gray-600">Vencimento:</span><span>${formatarData(lancamento.vencimento)}</span></div>
                    <div class="md:table-cell md:p-2 whitespace-nowrap text-lg md:text-base text-gray-900 font-semibold max-w-[60px] flex justify-between items-center"><span class="md:hidden text-sm font-semibold text-gray-600">Valor:</span><span>${formatarMoeda(lancamento.valor)}</span></div>
                    <div class="md:table-cell md:p-2 whitespace-nowrap text-base text-center hidden md:block">${lancamento.boleto ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500 mx-auto" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>` : ''}</div>
                    <div class="md:table-cell md:p-2 whitespace-nowrap text-base ${statusClass} flex justify-between items-center"><span class="md:hidden text-sm font-semibold text-gray-600">Status:</span><span class="px-2 py-1 rounded-full text-xs ${statusBgClass} ${statusClass}">${status}</span></div>
                    <div class="md:table-cell md:p-2 whitespace-nowrap text-base font-medium pt-4 md:pt-0"><div class="flex items-center space-x-2 justify-end md:justify-start">
                        <button class="text-blue-600 hover:text-blue-900" onclick="abrirFormularioParaEditar(${lancamento.id})" title="Editar"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg></button>
                        <button class="text-red-600 hover:text-red-900" onclick="confirmarExclusao(${lancamento.id})" title="Excluir"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                        ${!lancamento.data_pagt ? `<button class="text-green-600 hover:text-green-900" onclick="marcarComoPago(${lancamento.id})" title="Marcar como Pago"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 21.5a9.5 9.5 0 1 0-9.5-9.5A9.5 9.5 0 0 0 12 21.5z"/><path d="M12 17.5V12M12 6.5V12"/><path d="M9 9.5h6"/><path d="M9 14.5h6"/></svg></button>` : ''}
                    </div></div><span class="tooltiptext">${lancamento.observacao || 'Nenhuma observa√ß√£o'}</span>`;
                
                let tooltipTimer;
                linha.addEventListener('mouseenter', () => {
                    clearTimeout(tooltipTimer);
                    const tooltip = linha.querySelector('.tooltiptext');
                    if (tooltip) {
                        tooltipTimer = setTimeout(() => {
                            tooltip.style.visibility = 'visible';
                            tooltip.style.opacity = '1';
                        }, tooltipDelay);
                    }
                });
                linha.addEventListener('mouseleave', () => {
                    clearTimeout(tooltipTimer);
                    const tooltip = linha.querySelector('.tooltiptext');
                    if (tooltip) {
                        tooltip.style.visibility = 'hidden';
                        tooltip.style.opacity = '0';
                    }
                });
                tabelaBody.appendChild(linha);
            });
            
            atualizarCardsDeResumo(lancamentosFiltrados);
            
            const totalValor = lancamentosFiltrados.reduce((sum, l) => sum + l.valor, 0);
            const totalPago = lancamentosFiltrados.reduce((sum, l) => sum + (l.valor_pago || 0), 0);
            printTotalValor.textContent = formatarMoeda(totalValor);
            printTotalPago.textContent = formatarMoeda(totalPago);
            printTotalQuantidade.textContent = lancamentosFiltrados.length;
        };
        
        const abrirModal = () => {
            modal.classList.remove('hidden');
            modal.querySelector('div').classList.add('scale-100');
        };
        
        const fecharModal = () => {
            modal.querySelector('div').classList.remove('scale-100');
            modal.classList.add('hidden');
            formLancamento.reset();
            esferaDisplay.textContent = '';
            ativarParcelasCheckbox.checked = false;
            camposParcelasDiv.classList.add('hidden');
            parcelasSection.style.display = 'block'; // Garante que a se√ß√£o de parcelas reapare√ßa
        };

        btnNovo.onclick = () => {
            modalTitle.textContent = 'Novo Lan√ßamento';
            lancamentoIdField.value = '';
            esferaDisplay.textContent = '';
            parcelasSection.style.display = 'block'; // Garante que a se√ß√£o de parcelas esteja vis√≠vel para novos lan√ßamentos
            abrirModal();
        };

        closeButtons.forEach(btn => {
            btn.onclick = fecharModal;
        });

        btnCancel.onclick = fecharModal;
        
        window.onclick = (event) => {
            if (event.target === modal) {
                fecharModal();
            }
        };

        empresaSelect.addEventListener('change', (event) => {
            const empresa = event.target.value;
            let esfera = '';
            if (empresa === 'FOX' || empresa === 'S.OLIVEIRA') {
                esfera = 'Empresa';
            } else if (empresa) {
                esfera = 'Pessoal';
            }
            esferaDisplay.textContent = esfera;
        });

        formLancamento.onsubmit = async (e) => {
            e.preventDefault();
            const ativarParcelas = ativarParcelasCheckbox.checked;
            const numParcelas = parseInt(numParcelasInput.value, 10);
            const intervalo = parseInt(intervaloParcelasInput.value, 10);
            const unidade = unidadeParcelasSelect.value;
            const id = lancamentoIdField.value;

            if (id && ativarParcelas) {
                alert("N√£o √© poss√≠vel editar em modo parcelado. Desative a op√ß√£o para editar este lan√ßamento.");
                return;
            }

            if (ativarParcelas && (!numParcelas || numParcelas < 2 || !intervalo || intervalo < 1)) {
                alert("Para lan√ßar em parcelas, informe a quantidade (m√≠nimo 2) e o intervalo (m√≠nimo 1).");
                return;
            }
            
            const docBase = document.getElementById('doc').value || '';
            const credorBase = document.getElementById('credor').value.toUpperCase();
            const observacaoBase = document.getElementById('observacao').value.toUpperCase();
            const vencimentoBase = document.getElementById('vencimento').value;

            const lancamentoBase = {
                credor: credorBase,
                categoria: document.getElementById('categoria').value.toUpperCase(),
                tipo: document.getElementById('tipo').value.toUpperCase(),
                empresa: document.getElementById('empresa').value,
                emissao: document.getElementById('emissao').value || null,
                vencimento: vencimentoBase,
                valor: parseFloat(document.getElementById('valor').value),
                data_pagt: document.getElementById('data_pagt').value || null,
                valor_pago: parseFloat(document.getElementById('valor_pago').value) || null,
                onde_pagou: document.getElementById('onde_pagou').value.toUpperCase(),
                esfera: esferaDisplay.textContent,
                boleto: document.getElementById('boleto').checked ? 1 : 0,
            };

            if (ativarParcelas) {
                const lancamentosParaSalvar = [];
                const dataVencimentoInicial = new Date(vencimentoBase + 'T12:00:00Z');

                for (let i = 0; i < numParcelas; i++) {
                    const novoLancamento = { ...lancamentoBase };
                    const dataParcela = new Date(dataVencimentoInicial);

                    if (unidade === 'meses') {
                        dataParcela.setMonth(dataParcela.getMonth() + (i * intervalo));
                    } else { // 'dias'
                        dataParcela.setDate(dataParcela.getDate() + (i * intervalo));
                    }
                    novoLancamento.vencimento = dataParcela.toISOString().split('T')[0];
                    
                    const infoParcela = `P ${i + 1}/${numParcelas}`;
                    novoLancamento.doc = docBase ? `${docBase} - ${infoParcela}` : infoParcela;
                    
                    const infoParcelaObs = `(PARCELA ${i + 1}/${numParcelas})`;
                    novoLancamento.observacao = observacaoBase ? `${observacaoBase} ${infoParcelaObs}` : infoParcelaObs;
                    
                    novoLancamento.data_pagt = null;
                    novoLancamento.valor_pago = null;
                    novoLancamento.onde_pagou = '';

                    lancamentosParaSalvar.push(novoLancamento);
                }
                
                try {
                    const { error } = await supabase.from("lancamentos").insert(lancamentosParaSalvar);
                    if (error) throw error;
                    fetchLancamentos();
                    fecharModal();
                } catch (error) {
                    console.error("Erro ao salvar parcelas:", error);
                    alert("Ocorreu um erro ao salvar as parcelas.");
                }
            } else { // Lan√ßamento √∫nico ou edi√ß√£o
                const lancamentoFinal = { ...lancamentoBase, doc: docBase, observacao: observacaoBase };
                try {
                    if (id) {
                        const { error } = await supabase.from("lancamentos").update(lancamentoFinal).eq("id", id);
                        if (error) throw error;
                    } else {
                        const { error } = await supabase.from("lancamentos").insert([lancamentoFinal]);
                        if (error) throw error;
                    }
                    fetchLancamentos();
                    fecharModal();
                } catch (error) {
                    console.error("Erro ao salvar:", error);
                    alert("Ocorreu um erro ao salvar.");
                }
            }
        };
        
        window.marcarComoPago = (id) => {
            const lancamento = lancamentos.find(l => l.id === id);
            if (lancamento) {
                abrirFormularioParaEditar(id, true);
            }
        };

        window.abrirFormularioParaEditar = (id, isPaymentAction = false) => {
            const lancamento = lancamentos.find(l => l.id === id);
            if (lancamento) {
                parcelasSection.style.display = 'none'; // Oculta a se√ß√£o de parcelas na edi√ß√£o/pagamento
                
                lancamentoIdField.value = lancamento.id;
                document.getElementById('doc').value = lancamento.doc;
                document.getElementById('categoria').value = lancamento.categoria;
                document.getElementById('tipo').value = lancamento.tipo; 
                document.getElementById('credor').value = lancamento.credor;
                document.getElementById('empresa').value = lancamento.empresa;
                esferaDisplay.textContent = lancamento.esfera;
                document.getElementById('emissao').value = lancamento.emissao;
                document.getElementById('vencimento').value = lancamento.vencimento;
                document.getElementById('valor').value = lancamento.valor;
                document.getElementById('valor_pago').value = lancamento.valor_pago;
                document.getElementById('onde_pagou').value = lancamento.onde_pagou;
                document.getElementById('observacao').value = lancamento.observacao;
                document.getElementById('boleto').checked = lancamento.boleto;
                document.getElementById('data_pagt').value = lancamento.data_pagt;

                if (isPaymentAction) {
                    modalTitle.textContent = 'Confirmar Pagamento';
                    document.getElementById('data_pagt').value = new Date().toISOString().split('T')[0];
                    document.getElementById('valor_pago').value = lancamento.valor;
                } else {
                    modalTitle.textContent = 'Editar Lan√ßamento';
                }
                abrirModal();
            }
        };

        window.confirmarExclusao = async (id) => {
            if (confirm("Tem certeza que deseja excluir este lan√ßamento?")) {
                try {
                    const { error } = await supabase.from("lancamentos").delete().eq("id", id);
                    if (error) {
                        alert("Erro ao excluir: " + error.message);
                    } else {
                        fetchLancamentos();
                    }
                } catch (error) {
                    console.error('Falha na exclus√£o:', error);
                    alert("Ocorreu um erro ao excluir.");
                }
            }
        };

        const updateEsferaFilterButtons = (activeEsfera) => {
            esferaFilterButtons.forEach(btn => {
                const esfera = btn.dataset.esfera;
                if (esfera === activeEsfera) {
                    btn.classList.add('bg-slate-700', 'text-white');
                    btn.classList.remove('border-slate-700', 'hover:bg-slate-200', 'text-slate-700');
                } else {
                    btn.classList.remove('bg-slate-700', 'text-white');
                    btn.classList.add('border-slate-700', 'hover:bg-slate-200', 'text-slate-700');
                }
            });
        };

        const updateStatusFilterButtons = (activeStatus) => {
            statusFilterButtons.forEach(btn => {
                const status = btn.dataset.status;
                if (status === activeStatus) {
                    btn.classList.remove('bg-gray-200', 'hover:bg-gray-300', 'text-gray-700');
                    btn.classList.add('bg-blue-600', 'text-white');
                } else {
                    btn.classList.remove('bg-blue-600', 'text-white');
                    btn.classList.add('bg-gray-200', 'hover:bg-gray-300', 'text-gray-700');
                }
            });
        };
        
        esferaFilterButtons.forEach(button => {
            button.addEventListener('click', () => {
                currentEsferaFilter = button.dataset.esfera;
                updateEsferaFilterButtons(currentEsferaFilter);
                renderizarTabela();
            });
        });

        statusFilterButtons.forEach(button => {
            button.addEventListener('click', () => {
                currentStatusFilter = button.dataset.status;
                updateStatusFilterButtons(currentStatusFilter);
                renderizarTabela();
            });
        });

        filtroCredor.addEventListener('keyup', (e) => {
            currentCredorFilter = e.target.value;
            renderizarTabela();
        });

        filtroCategoria.addEventListener('change', (e) => {
            currentCategoriaFilter = e.target.value;
            renderizarTabela();
        });

        filtroTipo.addEventListener('change', (e) => {
            currentTipoFilter = e.target.value;
            renderizarTabela();
        });

        btnLimparFiltroCredor.addEventListener('click', () => {
            filtroCredor.value = '';
            filtroCategoria.value = 'Todos';
            filtroTipo.value = 'Todos';
            currentCredorFilter = '';
            currentCategoriaFilter = 'Todos';
            currentTipoFilter = 'Todos';
            renderizarTabela();
        });

        filtroInicial.addEventListener('change', (e) => {
            currentStartDate = e.target.value;
            renderizarTabela();
        });

        filtroFinal.addEventListener('change', (e) => {
            currentEndDate = e.target.value;
            renderizarTabela();
        });

        btnLimparFiltroPeriodo.addEventListener('click', () => {
            filtroInicial.value = '';
            filtroFinal.value = '';
            currentStartDate = null;
            currentEndDate = null;
            renderizarTabela();
        });
        
        const montarFiltrosAtivos = () => {
            const filtros = [];
            if (currentEsferaFilter !== 'Todos') { filtros.push(`Esfera: ${currentEsferaFilter.toUpperCase()}`); }
            if (currentStatusFilter !== 'Todos' && currentStatusFilter !== 'Hoje') { filtros.push(`Status: ${currentStatusFilter.toUpperCase()}`); }
            if (currentStartDate && currentEndDate) { const start = formatarData(currentStartDate); const end = formatarData(currentEndDate); filtros.push(`Per√≠odo: ${start} - ${end}`); }
            if (currentCredorFilter) { filtros.push(`Credor: ${currentCredorFilter.toUpperCase()}`); }
            if (currentCategoriaFilter !== 'Todos') { filtros.push(`Categoria: ${currentCategoriaFilter.toUpperCase()}`); }
            if (currentTipoFilter !== 'Todos') { filtros.push(`Tipo: ${currentTipoFilter.toUpperCase()}`); }
            
            if (filtros.length === 0) {
                filtersContentElement.textContent = 'Nenhum filtro espec√≠fico aplicado.';
            } else {
                filtersContentElement.innerHTML = filtros.join('<span class="mx-3 text-gray-500">|</span>');
            }
        };

        const imprimirRelatorio = () => {
            montarFiltrosAtivos();
            mainContainer.classList.add('print-paisagem'); 
            setTimeout(() => { window.print(); }, 50); 
            setTimeout(() => { mainContainer.classList.remove('print-paisagem'); }, 100);
        };
        
        btnImprimirRelatorio.addEventListener('click', imprimirRelatorio);
        
        updateStatusFilterButtons(currentStatusFilter);
        updateEsferaFilterButtons(currentEsferaFilter);
        fetchLancamentos();
        supabase.channel("lancamentos-changes").on("postgres_changes", { event: "*", schema: "public", table: "lancamentos" }, () => { fetchLancamentos(); }).subscribe();
    });
</script>

</body>
</html>