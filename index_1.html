<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Contas a Pagar</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // üîë Troque pelas credenciais do seu projeto Supabase
    const supabaseUrl = "https://vhfypgmvirktufrbgjjo.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZoZnlwZ212aXJrdHVmcmJnampvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNzIyMzUsImV4cCI6MjA3NDk0ODIzNX0.lVaVj1xbkEKK2tAytb5_m6X3FB0mnNzqla_kI0Fj2g4";
    
    // Inicializa√ß√£o correta usando o objeto global 'supabase' exposto pela CDN
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
  </script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        /* Estilos espec√≠ficos para o tooltip, j√° que o CSS puro √© mais f√°cil aqui */
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 250px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-50 p-8">

<div class="container mx-auto max-w-7xl bg-white p-6 rounded-xl shadow-lg">
    <header class="flex justify-between items-center mb-6 border-b pb-4 border-gray-200">
        <h1 class="text-3xl font-bold text-gray-800">Contas a Pagar</h1>
        <div class="flex items-center gap-4">
            <button id="btnImportar" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-6 rounded-lg transition-colors shadow-md">Importar</button>
            <button id="btnNovo" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition-colors shadow-md">+ Novo</button>
        </div>
    </header>

    <div id="esfera-filters" class="flex justify-start gap-4 mb-6">
        <button class="esfera-btn px-6 py-2 rounded-xl font-bold text-lg transition-colors border-2 border-transparent bg-slate-700 text-white" data-esfera="Todos">Todos</button>
        <button class="esfera-btn px-6 py-2 rounded-xl font-bold text-lg transition-colors border-2 border-slate-700 hover:bg-slate-200 text-slate-700" data-esfera="Empresa">Empresa</button>
        <button class="esfera-btn px-6 py-2 rounded-xl font-bold text-lg transition-colors border-2 border-slate-700 hover:bg-slate-200 text-slate-700" data-esfera="Pessoal">Pessoal</button>
    </div>
    
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
        <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 shadow-sm text-center">
            <h3 class="text-sm font-semibold text-blue-700 uppercase tracking-wide">Total de Lan√ßamentos</h3>
            <p id="total-valor" class="mt-1 text-xl font-bold text-blue-900">R$ 0,00</p>
        </div>
        <div class="bg-green-50 border border-green-200 rounded-xl p-4 shadow-sm text-center">
            <h3 class="text-sm font-semibold text-green-700 uppercase tracking-wide">Total Pago</h3>
            <p id="total-pago" class="mt-1 text-xl font-bold text-green-900">R$ 0,00</p>
        </div>
        <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 shadow-sm text-center">
            <h3 class="text-sm font-semibold text-yellow-700 uppercase tracking-wide">Quantidade de Lan√ßamentos</h3>
            <p id="total-quantidade" class="mt-1 text-xl font-bold text-yellow-900">0</p>
        </div>
    </div>

    <div class="mb-6 flex flex-col md:flex-row md:items-center justify-between space-y-4 md:space-y-0">
        <div class="flex-grow mr-4 flex items-center gap-2">
            <input type="search" id="filtro-credor" placeholder="Buscar por credor..." class="block w-full text-lg rounded-md border-gray-500 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition-colors">
            <button id="btn-limpar-credor" class="px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 transition-colors">Limpar</button>
        </div>
        <div class="flex flex-wrap items-center gap-2">
            <select id="filtro-categoria" class="rounded-md border-gray-300 shadow-sm text-sm">
                <option value="Todos">Categoria</option>
            </select>
            <select id="filtro-tipo" class="rounded-md border-gray-300 shadow-sm text-sm">
                <option value="Todos">Tipo</option>
            </select>
            <div id="status-filters" class="flex flex-wrap gap-2">
                <button class="status-btn px-4 py-2 rounded-lg font-semibold transition-colors border border-gray-300 bg-blue-600 text-white" data-status="Todos">Todos</button>
                <button class="status-btn px-4 py-2 rounded-lg font-semibold transition-colors border border-gray-300 bg-gray-200 hover:bg-gray-300 text-gray-700" data-status="Hoje">Hoje</button>
                <button class="status-btn px-4 py-2 rounded-lg font-semibold transition-colors border border-gray-300 bg-gray-200 hover:bg-gray-300 text-gray-700" data-status="A Vencer">A Vencer</button>
                <button class="status-btn px-4 py-2 rounded-lg font-semibold transition-colors border border-gray-300 bg-gray-200 hover:bg-gray-300 text-gray-700" data-status="Vencido">Vencido</button>
                <button class="status-btn px-4 py-2 rounded-lg font-semibold transition-colors border border-gray-300 bg-gray-200 hover:bg-gray-300 text-gray-700" data-status="Pago">Pago</button>
            </div>
        </div>
    </div>
    
    <div class="flex items-center space-x-2 mb-6">
        <label for="filtro-inicial" class="text-sm font-medium text-gray-700">De:</label>
        <input type="date" id="filtro-inicial" class="rounded-md border-gray-300 shadow-sm text-sm">
        <label for="filtro-final" class="text-sm font-medium text-gray-700">At√©:</label>
        <input type="date" id="filtro-final" class="rounded-md border-gray-300 shadow-sm text-sm">
        <button id="btn-limpar-periodo" class="px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 transition-colors">Limpar</button>
    </div>

    <div class="overflow-x-auto">
        <table id="tabelaLancamentos" class="min-w-full divide-y divide-gray-400">
            <thead class="bg-gray-300">
                <tr>
                    <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider max-w-[50px] overflow-hidden">DOC.</th>
                    <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider min-w-[120px]">Credor</th>
                    <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider min-w-[100px]">Categoria</th>
                    <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Empresa</th>
                    <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider font-bold">Vencimento</th>
                    <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Valor</th>
                    <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Boleto</th>
                    <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Status</th>
                    <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">A√ß√µes</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                </tbody>
        </table>
    </div>
</div>

<div id="modalNovoLancamento" class="fixed inset-0 bg-gray-900 bg-opacity-50 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden">
    <div class="bg-slate-400 p-8 rounded-lg shadow-2xl w-full max-w-3xl transform transition-all scale-95 duration-300 ease-in-out">
        <div class="flex flex-col items-center mb-6">
            <h2 id="modalTitle" class="text-2xl font-bold text-gray-800">Novo Lan√ßamento</h2>
            <span id="esfera" class="text-xs font-bold uppercase mt-2 px-4 py-1 rounded-full bg-slate-700 text-white"></span>
            <span class="close-btn absolute top-6 right-6 text-gray-500 hover:text-gray-800 text-3xl font-bold cursor-pointer transition-colors">&times;</span>
        </div>
        
        <form id="formLancamento" class="space-y-4">
            <input type="hidden" id="lancamentoId">
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="col-span-1">
                    <label for="doc" class="block text-sm font-medium text-gray-700">DOC</label>
                    <input type="text" id="doc" class="mt-1 block w-full text-base rounded-md bg-white border-gray-400 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition-colors">
                </div>
                <div class="col-span-1 md:col-span-1 lg:col-span-2">
                    <label for="credor" class="block text-sm font-medium text-gray-700">Credor<span class="text-red-500">*</span></label>
                    <input type="text" id="credor" required class="mt-1 block w-full text-base rounded-md bg-white border-gray-400 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition-colors">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label for="categoria" class="block text-sm font-medium text-gray-700">Categoria<span class="text-red-500">*</span></label>
                    <input type="text" id="categoria" required class="mt-1 block w-full text-base rounded-md bg-white border-gray-400 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition-colors">
                </div>
                <div>
                    <label for="tipo" class="block text-sm font-medium text-gray-700">Tipo<span class="text-red-500">*</span></label>
                    <select id="tipo" required class="mt-1 block w-full text-base rounded-md bg-white border-gray-400 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition-colors">
                        <option value="">Selecione...</option>
                        <option value="CUSTO FIXO">Custo Fixo</option>
                        <option value="CUSTO VARIAVEL">Custo Vari√°vel</option>
                        <option value="DESPESA FIXA">Despesa Fixa</option>
                        <option value="DESPESA VARIAVEL">Despesa Vari√°vel</option>
                        <option value="INVESTIMENTO">Investimento</option>
                        <option value="EMPR√âSTIMO">Empr√©stimo</option>
                    </select>
                </div>
                <div>
                    <label for="empresa" class="block text-sm font-medium text-gray-700">Empresa<span class="text-red-500">*</span></label>
                    <select id="empresa" required class="mt-1 block w-full text-base rounded-md bg-white border-gray-400 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition-colors">
                        <option value="">Selecione...</option>
                        <option value="FOX">FOX</option>
                        <option value="S.OLIVEIRA">S.OLIVEIRA</option>
                        <option value="PAULO">PAULO</option>
                        <option value="ANGELA">ANGELA</option>
                        <option value="KADU">KADU</option>
                        <option value="ANDERSON">ANDERSON</option>
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label for="emissao" class="block text-sm font-medium text-gray-700">Emiss√£o</label>
                    <input type="date" id="emissao" class="mt-1 block w-full text-base rounded-md bg-white border-gray-400 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition-colors">
                </div>
                <div>
                    <label for="vencimento" class="block text-sm font-medium text-gray-700">Vencimento<span class="text-red-500">*</span></label>
                    <input type="date" id="vencimento" required class="mt-1 block w-full text-base rounded-md bg-white border-gray-400 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition-colors">
                </div>
                <div>
                    <label for="valor" class="block text-sm font-medium text-gray-700">Valor<span class="text-red-500">*</span></label>
                    <input type="number" id="valor" step="0.01" required class="mt-1 block w-full text-base rounded-md bg-white border-gray-400 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition-colors">
                </div>
            </div>
            <div>
                <label for="observacao" class="block text-sm font-medium text-gray-700">Observa√ß√£o</label>
                <textarea id="observacao" rows="1" class="mt-1 block w-full text-base rounded-md bg-white border-gray-400 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition-colors"></textarea>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label for="data_pagt" class="block text-sm font-medium text-gray-700">Data Pagamento</label>
                    <input type="date" id="data_pagt" class="mt-1 block w-full text-base rounded-md bg-white border-gray-400 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition-colors">
                </div>
                <div>
                    <label for="valor_pago" class="block text-sm font-medium text-gray-700">Valor Pago</label>
                    <input type="number" id="valor_pago" step="0.01" class="mt-1 block w-full text-base rounded-md bg-white border-gray-400 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition-colors">
                </div>
                <div>
                    <label for="onde_pagou" class="block text-sm font-medium text-gray-700">Onde Pagou</label>
                    <input type="text" id="onde_pagou" class="mt-1 block w-full text-base rounded-md bg-white border-gray-400 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 transition-colors">
                </div>
            </div>
            
            <div class="flex items-center">
                <input id="boleto" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                <label for="boleto" class="ml-2 block text-base font-medium text-gray-700">Boleto Recebido</label>
            </div>
            
            <div class="flex justify-end items-center gap-4 pt-4">
                <button type="button" id="btnCancel" class="bg-red-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-600 transition-colors w-1/4">Cancelar</button>
                <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors flex-grow">Salvar</button>
            </div>
        </form>
    </div>
</div>

<div id="modalImportar" class="fixed inset-0 bg-gray-900 bg-opacity-50 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden">
    <div class="bg-slate-100 p-8 rounded-lg shadow-2xl w-full max-w-xl transform transition-all scale-95 duration-300 ease-in-out">
        <div class="flex flex-col items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800">Importar do Excel</h2>
            <span class="close-btn absolute top-6 right-6 text-gray-500 hover:text-gray-800 text-3xl font-bold cursor-pointer transition-colors">&times;</span>
        </div>
        
        <form id="formImportar" class="space-y-4">
            <div class="text-center">
                <p class="text-sm text-gray-600 mb-2">Selecione o arquivo Excel para importar. As colunas da planilha devem ser id√™nticas aos campos de cadastro.</p>
                <input type="file" id="arquivoExcel" accept=".xlsx" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100 transition-colors">
            </div>
            <div class="flex justify-end items-center gap-4 pt-4">
                <button type="button" id="btnImportCancel" class="bg-red-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-600 transition-colors w-1/4">Cancelar</button>
                <button type="submit" class="bg-yellow-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-yellow-700 transition-colors flex-grow">Importar Dados</button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const modal = document.getElementById('modalNovoLancamento');
        const modalImportar = document.getElementById('modalImportar');
        const btnNovo = document.getElementById('btnNovo');
        const btnImportar = document.getElementById('btnImportar');
        const spanClose = document.querySelector('.close-btn');
        const btnCancel = document.getElementById('btnCancel');
        const btnImportCancel = document.getElementById('btnImportCancel');
        const formLancamento = document.getElementById('formLancamento');
        const formImportar = document.getElementById('formImportar');
        const tabelaBody = document.querySelector('#tabelaLancamentos tbody');
        const lancamentoIdField = document.getElementById('lancamentoId');
        const modalTitle = document.getElementById('modalTitle');
        const empresaSelect = document.getElementById('empresa');
        const esferaDisplay = document.getElementById('esfera');

        const totalValorElement = document.getElementById('total-valor');
        const totalPagoElement = document.getElementById('total-pago');
        const totalQuantidadeElement = document.getElementById('total-quantidade');

        const esferaFilterButtons = document.querySelectorAll('.esfera-btn');
        const statusFilterButtons = document.querySelectorAll('.status-btn');
        const filtroCredor = document.getElementById('filtro-credor');
        const filtroCategoria = document.getElementById('filtro-categoria');
        const filtroTipo = document.getElementById('filtro-tipo');
        const btnLimparFiltroCredor = document.getElementById('btn-limpar-credor');
        const filtroInicial = document.getElementById('filtro-inicial');
        const filtroFinal = document.getElementById('filtro-final');
        const btnLimparFiltroPeriodo = document.getElementById('btn-limpar-periodo');


        let currentEsferaFilter = 'Todos';
        let currentStatusFilter = 'Todos';
        let currentCredorFilter = '';
        let currentCategoriaFilter = 'Todos';
        let currentTipoFilter = 'Todos';
        let currentStartDate = null;
        let currentEndDate = null;
        
        let lancamentos = []; // A lista agora come√ßa vazia e ser√° preenchida pela API

        const fetchLancamentos = async () => {
            const { data, error } = await supabase.from("lancamentos").select("*");
            if (error) {
                console.error("Erro ao buscar:", error);
                alert("N√£o foi poss√≠vel carregar os dados do Supabase");
                return;
            }
            lancamentos = data;
            popularFiltrosSelect();
            renderizarTabela();
        };


        const popularFiltrosSelect = () => {
            const categorias = [...new Set(lancamentos.map(l => l.categoria))];
            const tipos = [...new Set(lancamentos.map(l => l.tipo))];
            
            // Popula Categoria
            filtroCategoria.innerHTML = '<option value="Todos">Categoria</option>';
            categorias.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                filtroCategoria.appendChild(option);
            });

            // Popula Tipo
            filtroTipo.innerHTML = '<option value="Todos">Tipo</option>';
            tipos.forEach(tipo => {
                const option = document.createElement('option');
                option.value = tipo;
                option.textContent = tipo;
                filtroTipo.appendChild(option);
            });
        };

        const formatarData = (data) => {
            if (!data) return '';
            const [ano, mes, dia] = data.split('-');
            return `${dia}/${mes}/${ano}`;
        };

        const formatarMoeda = (valor) => {
            if (valor === null || valor === undefined) return 'R$ 0,00';
            const formatter = new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL',
            });
            return formatter.format(valor);
        };

        const getStatus = (lancamento) => {
            const hoje = new Date();
            const hojeFormatado = `${hoje.getFullYear()}-${String(hoje.getMonth() + 1).padStart(2, '0')}-${String(hoje.getDate()).padStart(2, '0')}`;
            
            if (lancamento.data_pagt) {
                return 'Pago';
            } else if (lancamento.vencimento === hojeFormatado) {
                return 'Hoje';
            } else if (lancamento.vencimento < hojeFormatado) {
                return 'Vencido';
            }
            return 'A Vencer';
        };

        const atualizarCardsDeResumo = (data) => {
            const totalValor = data.reduce((sum, l) => sum + l.valor, 0);
            const totalPago = data.reduce((sum, l) => sum + (l.valor_pago || 0), 0);
            const totalQuantidade = data.length;

            totalValorElement.textContent = formatarMoeda(totalValor);
            totalPagoElement.textContent = formatarMoeda(totalPago);
            totalQuantidadeElement.textContent = totalQuantidade;
        };

        const renderizarTabela = () => {
            tabelaBody.innerHTML = '';
            const hoje = new Date().toISOString().split('T')[0];

            let lancamentosFiltrados = lancamentos;

            // Filtro por Esfera (o primeiro a ser aplicado)
            if (currentEsferaFilter !== 'Todos') {
                lancamentosFiltrados = lancamentosFiltrados.filter(l => l.esfera === currentEsferaFilter);
            }
            
            // Filtro por Status
            if (currentStatusFilter !== 'Todos') {
                lancamentosFiltrados = lancamentosFiltrados.filter(l => getStatus(l) === currentStatusFilter);
            }

            // Filtro por Credor
            if (currentCredorFilter) {
                lancamentosFiltrados = lancamentosFiltrados.filter(l => 
                    l.credor.toLowerCase().includes(currentCredorFilter.toLowerCase())
                );
            }

            // Filtro por Categoria
            if (currentCategoriaFilter !== 'Todos') {
                lancamentosFiltrados = lancamentosFiltrados.filter(l => l.categoria === currentCategoriaFilter);
            }

            // Filtro por Tipo
            if (currentTipoFilter !== 'Todos') {
                lancamentosFiltrados = lancamentosFiltrados.filter(l => l.tipo === currentTipoFilter);
            }
            
            // Filtro por per√≠odo de vencimento
            if (currentStartDate && currentEndDate) {
                const start = new Date(currentStartDate);
                const end = new Date(currentEndDate);
                lancamentosFiltrados = lancamentosFiltrados.filter(l => {
                    const vencimento = new Date(l.vencimento);
                    // Adiciona um dia √† data final para incluir o dia completo
                    const finalComum = new Date(end);
                    finalComum.setDate(finalComum.getDate() + 1); 
                    return vencimento >= start && vencimento < finalComum;
                });
            }

            lancamentosFiltrados.sort((a, b) => new Date(a.vencimento) - new Date(b.vencimento));

            lancamentosFiltrados.forEach(lancamento => {
                const status = getStatus(lancamento);
                let statusClass = 'text-blue-600 font-semibold';
                if (status === 'Pago') {
                    statusClass = 'text-green-600 font-semibold';
                } else if (status === 'Hoje') {
                    statusClass = 'text-yellow-600 font-semibold';
                } else if (status === 'Vencido') {
                    statusClass = 'text-red-600 font-semibold';
                }
                
                const linha = document.createElement('tr');
                linha.className = 'hover:bg-gray-50 transition-colors group tooltip';
                linha.innerHTML = `
                    <td class="px-3 py-2 whitespace-nowrap text-xs text-gray-900 truncate max-w-[50px]">${lancamento.doc || ''}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-base text-gray-900 truncate max-w-[200px]">${lancamento.credor}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-600 truncate max-w-[100px]">${lancamento.categoria}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900 truncate max-w-[50px]">${lancamento.empresa}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-base font-bold text-gray-900">${formatarData(lancamento.vencimento)}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-base text-gray-900">${formatarMoeda(lancamento.valor)}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-base text-center">
                        ${lancamento.boleto ? `
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500 inline-block" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                        ` : ''}
                    </td>
                    <td class="px-3 py-2 whitespace-nowrap text-base ${statusClass}">${status}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-base font-medium">
                        <div class="flex items-center space-x-2">
                            <button class="text-blue-600 hover:text-blue-900" onclick="abrirFormularioParaEditar(${lancamento.id})" title="Editar">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                            </button>
                            <button class="text-red-600 hover:text-red-900" onclick="confirmarExclusao(${lancamento.id})" title="Excluir">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                            </button>
                            ${!lancamento.data_pagt ? `
                            <button class="text-green-600 hover:text-green-900" onclick="marcarComoPago(${lancamento.id})" title="Marcar como Pago">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 21.5a9.5 9.5 0 1 0-9.5-9.5A9.5 9.5 0 0 0 12 21.5z"/><path d="M12 17.5V12M12 6.5V12"/><path d="M9 9.5h6"/><path d="M9 14.5h6"/></svg>
                            </button>
                            ` : ''}
                        </div>
                    </td>
                    <span class="tooltiptext">${lancamento.observacao || 'Nenhuma observa√ß√£o'}</span>
                `;
                tabelaBody.appendChild(linha);
            });
            atualizarCardsDeResumo(lancamentosFiltrados);
        };
        
        const abrirModal = () => {
            modal.classList.remove('hidden');
            modal.querySelector('div').classList.add('scale-100');
        };
        
        const fecharModal = () => {
            modal.querySelector('div').classList.remove('scale-100');
            modal.classList.add('hidden');
            formLancamento.reset();
            esferaDisplay.textContent = ''; // Limpa o display da esfera
        };

        const abrirModalImportar = () => {
            modalImportar.classList.remove('hidden');
            modalImportar.querySelector('div').classList.add('scale-100');
        };

        const fecharModalImportar = () => {
            modalImportar.querySelector('div').classList.remove('scale-100');
            modalImportar.classList.add('hidden');
            formImportar.reset();
        };

        btnNovo.onclick = () => {
            modalTitle.textContent = 'Novo Lan√ßamento';
            lancamentoIdField.value = '';
            esferaDisplay.textContent = ''; // Inicia sem valor para a esfera
            abrirModal();
        };

        btnImportar.onclick = () => {
            abrirModalImportar();
        };

        spanClose.onclick = () => {
            fecharModal();
            fecharModalImportar();
        };

        btnCancel.onclick = fecharModal;
        btnImportCancel.onclick = fecharModalImportar;
        window.onclick = (event) => {
            if (event.target === modal) {
                fecharModal();
            } else if (event.target === modalImportar) {
                fecharModalImportar();
            }
        };

        empresaSelect.addEventListener('change', (event) => {
            const empresa = event.target.value;
            let esfera = '';
            if (empresa === 'FOX' || empresa === 'S.OLIVEIRA') {
                esfera = 'Empresa';
            } else if (empresa) {
                esfera = 'Pessoal';
            }
            esferaDisplay.textContent = esfera;
        });

        formLancamento.onsubmit = async (e) => {
            e.preventDefault();
            
            const novoLancamento = {
                doc: document.getElementById('doc').value || null,
                credor: document.getElementById('credor').value,
                categoria: document.getElementById('categoria').value,
                tipo: document.getElementById('tipo').value,
                empresa: document.getElementById('empresa').value,
                emissao: document.getElementById('emissao').value || null, 
                vencimento: document.getElementById('vencimento').value,
                valor: parseFloat(document.getElementById('valor').value),
                data_pagt: document.getElementById('data_pagt').value || null,
                valor_pago: parseFloat(document.getElementById('valor_pago').value) || null,
                onde_pagou: document.getElementById('onde_pagou').value,
                esfera: esferaDisplay.textContent,
                observacao: document.getElementById('observacao').value,
                boleto: document.getElementById('boleto').checked ? 1 : 0,
            };

            const id = lancamentoIdField.value;

            try {
                if (id) {
                    const { error } = await supabase.from("lancamentos").update(novoLancamento).eq("id", id);
                    if (error) throw error;
                } else {
                    const { error } = await supabase.from("lancamentos").insert([novoLancamento]);
                    if (error) throw error;
                }

                fetchLancamentos();
                fecharModal();
            } catch (error) {
                console.error("Erro ao salvar:", error);
                alert("Ocorreu um erro ao salvar. Tente novamente.");
            }

        };
        
        formImportar.onsubmit = async (e) => {
            e.preventDefault();
            const arquivoInput = document.getElementById('arquivoExcel');
            const file = arquivoInput.files[0];

            if (!file) {
                alert('Por favor, selecione um arquivo Excel.');
                return;
            }

            const formData = new FormData();
            formData.append('excelFile', file);

            try {
                const response = await fetch('/api/importar-lancamentos', {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Erro desconhecido ao importar.');
                }

                const result = await response.json();
                alert(result.message);
                if (result.falhas && result.falhas.length > 0) {
                    let mensagemFalhas = "Algumas linhas n√£o foram importadas devido a erros:\n";
                    result.falhas.forEach(f => {
                        mensagemFalhas += `Linha ${f.linha}: ${f.erro}\n`;
                    });
                    alert(mensagemFalhas);
                }
                fecharModalImportar();
                fetchLancamentos(); // Recarrega os dados da tabela
            } catch (error) {
                console.error('Erro na importa√ß√£o:', error);
                alert(`Ocorreu um erro na importa√ß√£o: ${error.message}`);
            }
        };

        window.marcarComoPago = (id) => {
            const lancamento = lancamentos.find(l => l.id === id);
            if (lancamento) {
                abrirFormularioParaEditar(id, true);
            }
        };

        window.abrirFormularioParaEditar = (id, isPaymentAction = false) => {
            const lancamento = lancamentos.find(l => l.id === id);
            if (lancamento) {
                lancamentoIdField.value = lancamento.id;
                document.getElementById('doc').value = lancamento.doc;
                document.getElementById('categoria').value = lancamento.categoria;
                document.getElementById('tipo').value = lancamento.tipo; // Esta linha garante que o campo Tipo seja preenchido
                document.getElementById('credor').value = lancamento.credor;
                document.getElementById('empresa').value = lancamento.empresa;
                esferaDisplay.textContent = lancamento.esfera;
                document.getElementById('emissao').value = lancamento.emissao;
                document.getElementById('vencimento').value = lancamento.vencimento;
                document.getElementById('valor').value = lancamento.valor;
                document.getElementById('valor_pago').value = lancamento.valor_pago;
                document.getElementById('onde_pagou').value = lancamento.onde_pagou;
                document.getElementById('observacao').value = lancamento.observacao;
                document.getElementById('boleto').checked = lancamento.boleto;
                document.getElementById('data_pagt').value = lancamento.data_pagt;

                if (isPaymentAction) {
                    modalTitle.textContent = 'Confirmar Pagamento';
                    document.getElementById('data_pagt').value = new Date().toISOString().split('T')[0];
                    document.getElementById('valor_pago').value = lancamento.valor;
                } else {
                    modalTitle.textContent = 'Editar Lan√ßamento';
                }

                abrirModal();
            }
        };

        window.confirmarExclusao = async (id) => {
            if (confirm("Tem certeza que deseja excluir este lan√ßamento? Esta a√ß√£o n√£o pode ser desfeita.")) {
                try {
                    const { error } = await supabase.from("lancamentos").delete().eq("id", id);
                    if (error) {
                        alert("Erro ao excluir: " + error.message);
                    } else {
                        fetchLancamentos();
                    }

                } catch (error) {
                    console.error('Falha na exclus√£o:', error);
                    alert("Ocorreu um erro ao excluir o lan√ßamento. Tente novamente.");
                }
            }
        };

        // L√≥gica dos filtros
        esferaFilterButtons.forEach(button => {
            button.addEventListener('click', () => {
                currentEsferaFilter = button.dataset.esfera;
                esferaFilterButtons.forEach(btn => {
                    btn.classList.remove('bg-slate-700', 'text-white');
                    btn.classList.add('border-slate-700', 'hover:bg-slate-200', 'text-slate-700');
                });
                button.classList.add('bg-slate-700', 'text-white');
                button.classList.remove('border-slate-700', 'hover:bg-slate-200', 'text-slate-700');
                renderizarTabela();
            });
        });

        statusFilterButtons.forEach(button => {
            button.addEventListener('click', () => {
                currentStatusFilter = button.dataset.status;
                statusFilterButtons.forEach(btn => {
                    btn.classList.remove('bg-blue-600', 'text-white');
                    btn.classList.add('bg-gray-200', 'hover:bg-gray-300', 'text-gray-700');
                });
                button.classList.add('bg-blue-600', 'text-white');
                button.classList.remove('bg-gray-200', 'hover:bg-gray-300', 'text-gray-700');
                renderizarTabela();
            });
        });

        filtroCredor.addEventListener('keyup', (e) => {
            currentCredorFilter = e.target.value;
            renderizarTabela();
        });

        filtroCategoria.addEventListener('change', (e) => {
            currentCategoriaFilter = e.target.value;
            renderizarTabela();
        });

        filtroTipo.addEventListener('change', (e) => {
            currentTipoFilter = e.target.value;
            renderizarTabela();
        });

        btnLimparFiltroCredor.addEventListener('click', () => {
            filtroCredor.value = '';
            filtroCategoria.value = 'Todos';
            filtroTipo.value = 'Todos';
            currentCredorFilter = '';
            currentCategoriaFilter = 'Todos';
            currentTipoFilter = 'Todos';
            renderizarTabela();
        });


        filtroInicial.addEventListener('change', (e) => {
            currentStartDate = e.target.value;
            renderizarTabela();
        });

        filtroFinal.addEventListener('change', (e) => {
            currentEndDate = e.target.value;
            renderizarTabela();
        });

        btnLimparFiltroPeriodo.addEventListener('click', () => {
            filtroInicial.value = '';
            filtroFinal.value = '';
            currentStartDate = null;
            currentEndDate = null;
            renderizarTabela();
        });

        // L√≥gica do Tooltip (mantida do c√≥digo original, j√° que se integra bem)
        const tooltipDelay = 2000;
        let tooltipTimer;
        
        tabelaBody.addEventListener('mouseover', (e) => {
            const row = e.target.closest('tr');
            if (row) {
                clearTimeout(tooltipTimer);
                tooltipTimer = setTimeout(() => {
                    const tooltip = row.querySelector('.tooltiptext');
                    if (tooltip) {
                        tooltip.style.visibility = 'visible';
                        tooltip.style.opacity = '1';
                    }
                }, tooltipDelay);
            }
        });
        
        tabelaBody.addEventListener('mouseout', (e) => {
            const row = e.target.closest('tr');
            if (row) {
                clearTimeout(tooltipTimer);
                const tooltip = row.querySelector('.tooltiptext');
                if (tooltip) {
                    tooltip.style.visibility = 'hidden';
                    tooltip.style.opacity = '0';
                }
            }
        });

        fetchLancamentos();
        supabase.channel("lancamentos-changes")
            .on("postgres_changes", { event: "*", schema: "public", table: "lancamentos" }, () => {
                fetchLancamentos();
            })
            .subscribe();

    });
</script>

</body>
</html>''